{"ast":null,"code":"import _slicedToArray from \"@babel/runtime/helpers/esm/slicedToArray\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport axios from 'axios';\nimport { apiConfig } from '../api.config';\nimport { filterEmptyParameters as removeEemptyParameters } from './utils';\nimport { BatchOperationError, FileUploadError } from './exceptions';\nvar FiduciaDynamicEndpoints;\n\n(function (FiduciaDynamicEndpoints) {\n  FiduciaDynamicEndpoints[\"Get\"] = \"getRef.do\";\n  FiduciaDynamicEndpoints[\"Do\"] = \"doRef.do\";\n  FiduciaDynamicEndpoints[\"Execute\"] = \"executeRef.do\";\n  FiduciaDynamicEndpoints[\"ExecuteJava\"] = \"executeJavaRef.do\";\n  FiduciaDynamicEndpoints[\"UploadFile\"] = \"upload.do\";\n  FiduciaDynamicEndpoints[\"ImprimirReporte\"] = \"imprimirReporte.do\";\n})(FiduciaDynamicEndpoints || (FiduciaDynamicEndpoints = {}));\n\nexport var Api = /*#__PURE__*/function () {\n  function Api(config) {\n    _classCallCheck(this, Api);\n\n    _defineProperty(this, \"api\", void 0);\n\n    this.api = axios.create(_objectSpread(_objectSpread({}, apiConfig), config)); // this middleware is been called right before the http request is made.\n\n    this.api.interceptors.request.use(function (param) {\n      return _objectSpread({}, param);\n    }); // this middleware is been called right before the response is get it by the method that triggers the request\n\n    this.api.interceptors.response.use(function (param) {\n      return _objectSpread({}, param);\n    });\n  }\n\n  _createClass(Api, [{\n    key: \"getUri\",\n    value: function getUri(config) {\n      return this.api.getUri(config);\n    }\n  }, {\n    key: \"request\",\n    value: function request(config) {\n      return this.api.request(config);\n    }\n  }, {\n    key: \"get\",\n    value: function get(url, config) {\n      return this.api.get(url, config);\n    }\n  }, {\n    key: \"delete\",\n    value: function _delete(url, config) {\n      return this.api[\"delete\"](url, config);\n    }\n  }, {\n    key: \"head\",\n    value: function head(url, config) {\n      return this.api.head(url, config);\n    }\n  }, {\n    key: \"post\",\n    value: function post(url, data, config) {\n      return this.api.post(url, data, config);\n    }\n  }, {\n    key: \"put\",\n    value: function put(url, data, config) {\n      return this.api.put(url, data, config);\n    }\n  }, {\n    key: \"patch\",\n    value: function patch(url, data, config) {\n      return this.api.patch(url, data, config);\n    }\n  }, {\n    key: \"sendDynamicRequest\",\n    value: function () {\n      var _sendDynamicRequest = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(endpoint, refName, params) {\n        var filterEmptyParameters,\n            filteredParams,\n            _args = arguments;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                filterEmptyParameters = _args.length > 3 && _args[3] !== undefined ? _args[3] : true;\n                filteredParams = filterEmptyParameters ? removeEemptyParameters(params) : params;\n                Object.assign(filteredParams, {\n                  id: refName\n                });\n                return _context.abrupt(\"return\", this.get(endpoint, {\n                  params: {\n                    json: JSON.stringify(filteredParams)\n                  }\n                }).then(function (response) {\n                  if (response === null) {\n                    throw new Error('Ocurrio un error al procesar el request');\n                  } else {\n                    return response;\n                  }\n                }));\n\n              case 4:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function sendDynamicRequest(_x, _x2, _x3) {\n        return _sendDynamicRequest.apply(this, arguments);\n      }\n\n      return sendDynamicRequest;\n    }()\n  }, {\n    key: \"downloadDynamicFile\",\n    value: function () {\n      var _downloadDynamicFile = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(filename, endpoint, refName, params) {\n        var _this = this;\n\n        var filterEmptyParameters,\n            filteredParams,\n            _args2 = arguments;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                filterEmptyParameters = _args2.length > 4 && _args2[4] !== undefined ? _args2[4] : true;\n                filteredParams = filterEmptyParameters ? removeEemptyParameters(params) : params;\n                Object.assign(filteredParams, {\n                  id: refName\n                });\n                return _context2.abrupt(\"return\", this.get(endpoint, {\n                  params: {\n                    json: JSON.stringify(filteredParams)\n                  },\n                  responseType: 'blob'\n                }).then(function (response) {\n                  if (response === null) {\n                    throw new Error('Ocurrio un error al procesar el request');\n                  } else {\n                    _this.downloadFile(response.data, filename);\n                  }\n                }));\n\n              case 4:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function downloadDynamicFile(_x4, _x5, _x6, _x7) {\n        return _downloadDynamicFile.apply(this, arguments);\n      }\n\n      return downloadDynamicFile;\n    }()\n  }, {\n    key: \"downloadFile\",\n    value: function downloadFile(file, filename) {\n      var anchor = window.document.createElement('a');\n      anchor.href = URL.createObjectURL(file);\n      anchor.download = filename;\n      document.body.appendChild(anchor);\n      anchor.click();\n      document.body.removeChild(anchor); // Removes browser reference to the file\n\n      setTimeout(function () {\n        URL.revokeObjectURL(anchor.href);\n      }, 250);\n    }\n  }, {\n    key: \"getRef\",\n    value: function () {\n      var _getRef = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(refName, params, transformer) {\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                return _context3.abrupt(\"return\", this.sendDynamicRequest(FiduciaDynamicEndpoints.Get, refName, params).then(function (response) {\n                  var data = response.data;\n                  return data.map(transformer);\n                }));\n\n              case 1:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function getRef(_x8, _x9, _x10) {\n        return _getRef.apply(this, arguments);\n      }\n\n      return getRef;\n    }()\n  }, {\n    key: \"executeRef\",\n    value: function () {\n      var _executeRef = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(refName, data) {\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                return _context4.abrupt(\"return\", this.sendDynamicRequest(FiduciaDynamicEndpoints.Execute, refName, data, false).then(function (response) {\n                  return response.data.result;\n                }));\n\n              case 1:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function executeRef(_x11, _x12) {\n        return _executeRef.apply(this, arguments);\n      }\n\n      return executeRef;\n    }()\n  }, {\n    key: \"doRef\",\n    value: function () {\n      var _doRef = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(refName, data) {\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                return _context5.abrupt(\"return\", this.sendDynamicRequest(FiduciaDynamicEndpoints.Execute, refName, data, false).then(function (response) {\n                  return response.data.result;\n                }));\n\n              case 1:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function doRef(_x13, _x14) {\n        return _doRef.apply(this, arguments);\n      }\n\n      return doRef;\n    }()\n  }, {\n    key: \"downloadDynamicReport\",\n    value: function () {\n      var _downloadDynamicReport = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(filename, refName, data) {\n        return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                this.downloadDynamicFile(filename, FiduciaDynamicEndpoints.ImprimirReporte, refName, data, true);\n\n              case 1:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n\n      function downloadDynamicReport(_x15, _x16, _x17) {\n        return _downloadDynamicReport.apply(this, arguments);\n      }\n\n      return downloadDynamicReport;\n    }()\n  }, {\n    key: \"executeRemoteMethod\",\n    value: function () {\n      var _executeRemoteMethod = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(refName, data) {\n        return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                return _context7.abrupt(\"return\", this.sendDynamicRequest(FiduciaDynamicEndpoints.ExecuteJava, refName, data, false).then(function (response) {\n                  return response.data.result;\n                }));\n\n              case 1:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n\n      function executeRemoteMethod(_x18, _x19) {\n        return _executeRemoteMethod.apply(this, arguments);\n      }\n\n      return executeRemoteMethod;\n    }()\n  }, {\n    key: \"handleBatchOperation\",\n    value: function handleBatchOperation(promises, models) {\n      return Promise.allSettled(promises).then(function (results) {\n        var failedModels = [];\n        results.forEach(function (result, index) {\n          if (result.status === 'rejected') {\n            failedModels.push(models[index]);\n          }\n        });\n\n        if (failedModels.length) {\n          var errorMessage = \"Operacion incompleta. Ocurrio un error al eliminar \".concat(failedModels.length, \" de \").concat(models.length, \" registro(s).\");\n          throw new BatchOperationError(failedModels, errorMessage);\n        }\n      });\n    }\n  }, {\n    key: \"getAsyncOperationStatus\",\n    value: function () {\n      var _getAsyncOperationStatus = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee8(transactionId) {\n        return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                return _context8.abrupt(\"return\", this.sendDynamicRequest(FiduciaDynamicEndpoints.Get, 'consultaEstatusTransaccionAsync', {\n                  transactionId: transactionId\n                }).then(function (response) {\n                  var data = response.data;\n\n                  if (!data || !data.length) {\n                    throw new Error('Ocurrio un error inesperado');\n                  }\n\n                  var result = data[0];\n                  var transactionCompleted = Boolean(result.transactionCompleted);\n                  var transactionError = result.transactionError;\n\n                  if (!transactionCompleted) {\n                    throw new Error(transactionError);\n                  }\n                }));\n\n              case 1:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this);\n      }));\n\n      function getAsyncOperationStatus(_x20) {\n        return _getAsyncOperationStatus.apply(this, arguments);\n      }\n\n      return getAsyncOperationStatus;\n    }()\n  }, {\n    key: \"uploadFiles\",\n    value: function uploadFiles(url) {\n      var files = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n      var params = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n      var formData = new FormData();\n      files.forEach(function (file, index) {\n        formData.append(\"file_\".concat(index + 1), file);\n      });\n      Object.entries(params).forEach(function (_ref) {\n        var _ref2 = _slicedToArray(_ref, 2),\n            key = _ref2[0],\n            value = _ref2[1];\n\n        formData.append(key, value);\n      });\n      return this.api.post(url, formData, {\n        headers: {\n          'Content-Type': 'multipart/form-data'\n        }\n      });\n    }\n  }, {\n    key: \"uploadFilesWithProcessor\",\n    value: function () {\n      var _uploadFilesWithProcessor = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee9() {\n        var files,\n            processorName,\n            otherParams,\n            transactionId,\n            _args9 = arguments;\n        return _regeneratorRuntime.wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                files = _args9.length > 0 && _args9[0] !== undefined ? _args9[0] : [];\n                processorName = _args9.length > 1 ? _args9[1] : undefined;\n                otherParams = _args9.length > 2 && _args9[2] !== undefined ? _args9[2] : {};\n                // TODO: Cambiar por UUID\n                transactionId = \"\".concat(Math.floor(Math.random() * 1000000));\n                _context9.prev = 4;\n                _context9.next = 7;\n                return this.uploadFiles(FiduciaDynamicEndpoints.UploadFile, files, _objectSpread(_objectSpread({}, otherParams), {}, {\n                  numTransaccion: transactionId,\n                  processor: processorName\n                }));\n\n              case 7:\n                _context9.next = 13;\n                break;\n\n              case 9:\n                _context9.prev = 9;\n                _context9.t0 = _context9[\"catch\"](4);\n                console.log('error al subir archivo', _context9.t0);\n                throw new FileUploadError();\n\n              case 13:\n                _context9.prev = 13;\n                _context9.next = 16;\n                return this.getAsyncOperationStatus(transactionId);\n\n              case 16:\n                return _context9.finish(13);\n\n              case 17:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9, this, [[4, 9, 13, 17]]);\n      }));\n\n      function uploadFilesWithProcessor() {\n        return _uploadFilesWithProcessor.apply(this, arguments);\n      }\n\n      return uploadFilesWithProcessor;\n    }()\n  }]);\n\n  return Api;\n}();","map":null,"metadata":{},"sourceType":"module"}