{"ast":null,"code":"import React from \"react\";\nvar __jsx = React.createElement;\nimport '../styles.css';\nimport Router from 'next/router';\nimport { useEffect, useState } from 'react';\nimport { ThemeProvider } from '@material-ui/core/styles';\nimport CssBaseline from '@material-ui/core/CssBaseline';\nimport Typography from '@material-ui/core/Typography';\nimport { makeStyles } from '@material-ui/core/styles';\nimport CircularProgress from '@material-ui/core/CircularProgress';\nimport { catalogsApi } from '../core/api';\nimport SessionService from '../services/SessionService';\nimport Login from '../modules/Login/MainLogin';\nimport BaseTheme from '../sharedComponents/BaseTheme';\nimport { SessionInfoContext } from '../core/LoginContext';\nimport LoginService from '../services/LoginService';\nimport { SnackbarProvider } from 'notistack';\nimport Layout from '../sharedComponents/Layout';\n\nfunction removeInjectedServerCss() {\n  // Remove the server-side injected CSS.\n  const jssStyles = document.querySelector('#jss-server-side');\n\n  if (jssStyles && jssStyles.parentElement) {\n    jssStyles.parentElement.removeChild(jssStyles);\n  }\n}\n\nasync function tryLogin() {\n  try {\n    const ssoSessionInfo = await LoginService.ssoLogin();\n\n    if (!ssoSessionInfo) {\n      return null;\n    }\n\n    const userInfo = LoginService.login(ssoSessionInfo.user.username, '', true);\n    await catalogsApi.fetchAll();\n    return userInfo;\n  } catch (err) {\n    console.log('Login Error', err);\n    return null;\n  }\n}\n\nconst useStyles = makeStyles({\n  loadingMessage: {\n    display: 'flex',\n    justifyContent: 'center',\n    height: '100vh',\n    alignItems: 'center'\n  },\n  loadingIcon: {\n    marginRight: '1rem'\n  }\n});\n\nfunction App({\n  Component,\n  pageProps\n}) {\n  const classes = useStyles();\n  const {\n    0: modulePermissionsMap,\n    1: setModulePermissionsMap\n  } = useState(null);\n  const {\n    0: sessionInfo,\n    1: setSessionInfo\n  } = useState(null);\n  const {\n    0: loadingApp,\n    1: setLoadingApp\n  } = useState(true);\n  useEffect(() => {\n    removeInjectedServerCss();\n    tryLogin().then(ssoSessionInfo => {\n      if (!ssoSessionInfo) {\n        setLoadingApp(false);\n        return handleLogout(false);\n      }\n\n      SessionService.create(ssoSessionInfo);\n      setLoadingApp(false);\n      handleSuccessfulLogin(false);\n    });\n  }, []);\n\n  function handleSuccessfulLogin(redirect = true) {\n    const {\n      sessionInfo,\n      permissionsMap\n    } = SessionService.get();\n    setSessionInfo(sessionInfo);\n    setModulePermissionsMap(permissionsMap);\n\n    if (redirect) {\n      Router.push('/');\n    }\n  }\n\n  function handleLogout(redirect = true) {\n    SessionService.delete();\n    setSessionInfo(null); // Clear cookies\n\n    document.cookie = 'accessData=;expires=Thu, 01 Jan 1970 00:00:00 GMT';\n\n    if (redirect) {\n      Router.push('/');\n    }\n  }\n\n  let component = __jsx(Typography, {\n    className: classes.loadingMessage,\n    variant: \"subtitle1\"\n  }, __jsx(CircularProgress, {\n    className: classes.loadingIcon\n  }), \"Cargando, por favor espere...\");\n\n  if (!loadingApp) {\n    component = sessionInfo ? __jsx(Layout, null, __jsx(Component, pageProps)) : __jsx(Login, {\n      onLogin: handleSuccessfulLogin\n    });\n  }\n\n  return __jsx(React.Fragment, null, __jsx(CssBaseline, null), __jsx(ThemeProvider, {\n    theme: BaseTheme\n  }, __jsx(SnackbarProvider, {\n    maxSnack: 3\n  }, __jsx(SessionInfoContext.Provider, {\n    value: {\n      sessionInfo: sessionInfo,\n      onLogout: handleLogout,\n      modulePermissionsMap: modulePermissionsMap\n    }\n  }, component))));\n}\n\nexport default App;","map":null,"metadata":{},"sourceType":"module"}